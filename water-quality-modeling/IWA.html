

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

    <title>4. IWA River Water Quality Model &#8212; Water Quality Modeling</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=ac02cc09edc035673794" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=ac02cc09edc035673794" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=ac02cc09edc035673794" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.4045f2051d55cab465a707391d5b2007.min.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=ac02cc09edc035673794"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'water-quality-modeling/IWA';</script>
    <link rel="canonical" href="https://Gakkykun.github.io/water-quality-modeling/water-quality-modeling/IWA.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Lake Model" href="lakeModel.html" />
    <link rel="prev" title="3. Streeter Phelps Model" href="streeterPhelps.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Logo image"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Logo image"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Chapters</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="fortranBasics.html">1. Fortran basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="differentialEquation.html">2. Differential Equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="streeterPhelps.html">3. Streeter Phelps Model</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">4. IWA River Water Quality Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="lakeModel.html">5. Lake Model</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Appendices</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="bibliography.html">Bibliography</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://mybinder.org/v2/gh/Gakkykun/water-quality-modeling/master?urlpath=tree/water-quality-modeling/IWA.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onBinder"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="btn__text-container">Binder</span>
</a>
</li>
      
      
      
      
      <li><a href="https://colab.research.google.com/github/Gakkykun/water-quality-modeling/blob/master/water-quality-modeling/IWA.md" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch onColab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/Gakkykun/water-quality-modeling" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Gakkykun/water-quality-modeling/edit/main/water-quality-modeling/IWA.md" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/Gakkykun/water-quality-modeling/issues/new?title=Issue%20on%20page%20%2Fwater-quality-modeling/IWA.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/water-quality-modeling/IWA.ipynb" target="_blank"
   class="btn btn-sm btn-download-notebook-button dropdown-item"
   title="Download notebook file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-code"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li><a href="../_sources/water-quality-modeling/IWA.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>IWA River Water Quality Model</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">4.1. Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">4.2. Implementation</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="iwa-river-water-quality-model">
<h1><span class="section-number">4. </span>IWA River Water Quality Model<a class="headerlink" href="#iwa-river-water-quality-model" title="Permalink to this heading">#</a></h1>
<section id="background">
<h2><span class="section-number">4.1. </span>Background<a class="headerlink" href="#background" title="Permalink to this heading">#</a></h2>
<p>The river water quality model no.1 (RWQM1) was developed to facilitate practical application of river water quality modeling <span id="id1">[<a class="reference internal" href="bibliography.html#id5" title="Peter Reichert, Dietrich Borchardt, Mogens Henze, Wolfgang Rauch, Peter Shanahan, Laszlo Somlyody, and Peter A Vanrolleghem. River water quality model. Number 1. IWA publishing, 2001.">Reichert <em>et al.</em>, 2001</a>]</span>. It offers a suitable description of nutrient and community dynamics and represents flows of carbon, hydrogen, oxygen, nitrogen and phosphorus through an aquatic “food web” <span id="id2">[<a class="reference internal" href="bibliography.html#id3" title="Niall Broekhuizen, Jason BK Park, Graham B McBride, and Rupert J Craggs. Modification, calibration and verification of the iwa river water quality model to simulate a pilot-scale high rate algal pond. Water research, 46(9):2911–2926, 2012.">Broekhuizen <em>et al.</em>, 2012</a>]</span>. The followings are assumptions of this model:</p>
<ul class="simple">
<li><p>The elemental composition (e.g., C, H, O, N, and P) of all compounds and organisms is constant.</p></li>
<li><p>The stoichiometry of all processes is constant.</p></li>
<li><p>No adaptation of specific organisms takes place.</p></li>
<li><p>Changes in the composition within organism classes are neglected.</p></li>
</ul>
<p>Although there are a number of biological and chemical water quality transformation processes occurring in real nature, identification of main processes is an important step in the modeling. Kinetics and stoichiometry relevant to those processes are incorporated into mass balance equations:</p>
<div class="math notranslate nohighlight">
\[
\frac{\partial C_i}{\partial t} = r_i = \sum\nu_{i,j}\rho_j
\]</div>
<p>where <span class="math notranslate nohighlight">\(r_i\)</span> is a reaction rate, <span class="math notranslate nohighlight">\(\nu_{i,j}\)</span> is a stoichiometry, and <span class="math notranslate nohighlight">\(\rho_j\)</span> is a process rate. The IWA model deals with dissolved (denoted as <span class="math notranslate nohighlight">\(S\)</span>) and particulate (denoted as <span class="math notranslate nohighlight">\(X\)</span>) materials as shown below.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Symbol</p></th>
<th class="head"><p>Dissolved component</p></th>
<th class="head"><p>Unit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(S_S\)</span></p></td>
<td><p>Dissolved organic substrate for heterotrophic growth</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(S_I\)</span></p></td>
<td><p>Dissolved inert substrate for heterotrophic growth</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(S_{NH_4}\)</span>, <span class="math notranslate nohighlight">\(S_{NH_3}\)</span></p></td>
<td><p>Ammonium and ammonia</p></td>
<td><p>g N <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(S_{NO_2}\)</span>, <span class="math notranslate nohighlight">\(S_{NO_3}\)</span></p></td>
<td><p>Nitrite- and nitrate-NAmmonium and ammonia</p></td>
<td><p>g N <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(S_{HPO_4}\)</span>,<span class="math notranslate nohighlight">\(S_{H_2PO_4}\)</span></p></td>
<td><p>Two components of dissolved inorganic P</p></td>
<td><p>g P <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(S_{O_2}\)</span></p></td>
<td><p>Dissolved oxygen</p></td>
<td><p>g <span class="math notranslate nohighlight">\(O_2\)</span> <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(S_{CO_2}\)</span>,<span class="math notranslate nohighlight">\(S_{HCO_3}\)</span>,<span class="math notranslate nohighlight">\(S_{H_2CO_3}\)</span></p></td>
<td><p>Components of total dissolved inorganic carbon</p></td>
<td><p>g C <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(S_{H}\)</span></p></td>
<td><p>Hydrogen ion</p></td>
<td><p>g H <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(S_{OH}\)</span></p></td>
<td><p>Hydroxyl-ion</p></td>
<td><p>g H <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(S_{Ca}\)</span></p></td>
<td><p>Calcium ion</p></td>
<td><p>g Ca <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(X_H\)</span></p></td>
<td><p>Heterotrophic osmotrophs</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(X_{N1}\)</span></p></td>
<td><p>First-stage nitrifiers: oxidizing ammonia to nitrite</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(X_{N2}\)</span></p></td>
<td><p>Second-stage nitrifiers: oxidizing nitrite to nitrate</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(X_{ALG}\)</span></p></td>
<td><p>Photosynthetic organisms</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(X_{CON}\)</span></p></td>
<td><p>Consumer organisms</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(X_{S}\)</span></p></td>
<td><p>Non-refratory particulate organic matter</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(X_{I}\)</span></p></td>
<td><p>Refratory particulate organic matter</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(X_{P}\)</span></p></td>
<td><p>Phosphate adsorbed to particles</p></td>
<td><p>g COD <span class="math notranslate nohighlight">\(m^{-3}\)</span></p></td>
</tr>
</tbody>
</table>
<p>Before looking at the IWA model, let’s first consider the very simple system in which there are just three components: bacteria, substrate and dissolved oxygen. Process kinetics and stoichiometry for heterotrophic bacterial growth and decay in an aerobic environment are summarized in a matrix form. The column represents the three components, whereas the row does processes involved in this sytem, which are growth and decay. There is an additional column for process rates.</p>
<p>Using this matrix, we can mechanistically construct reaction rates for each component, simply multiplying a stoichiometry by a process rate in the same row and sum them in the column direction. Reaction rates for bacteria biomass (<span class="math notranslate nohighlight">\(X_B\)</span>), soluble substrate(<span class="math notranslate nohighlight">\(S_s\)</span>), dissolved oxygen(<span class="math notranslate nohighlight">\(S_o\)</span>) are given by:</p>
<p>For biomass:</p>
<div class="math notranslate nohighlight">
\[
r_{X_B} = 1\cdot{\frac{\hat{\mu}S_s}{K_s + S_S}}X_B - 1\cdot{bX_B}
\]</div>
<p>For substrate:</p>
<div class="math notranslate nohighlight">
\[
r_{S_s} = -\frac{1}{Y}\frac{\hat{\mu}S_s}{K_s + S_S}X_B
\]</div>
<p>For dissolved oxygen</p>
<div class="math notranslate nohighlight">
\[
r_{S_o} = -\frac{1-Y}{Y}\frac{\hat{\mu}S_s}{K_s + S_S}X_B - 1\cdot{bX_B}
\]</div>
<p>Now, let’s move on to how bacteria population is formulated, which is referred to as Monod kinetics. A specific growth rate, which has a unit of <span class="math notranslate nohighlight">\(\frac{1}{d}\)</span>, represents a ratio of biomass variation (<span class="math notranslate nohighlight">\(\frac{dX}{dt}\)</span>) to the biomass (<span class="math notranslate nohighlight">\(X\)</span>):</p>
<div class="math notranslate nohighlight">
\[
\mu \equiv \frac{1}{X}\frac{dX}{dt}
\]</div>
<p>In Monod equation, <span class="math notranslate nohighlight">\(\mu\)</span> is represented by:</p>
<div class="math notranslate nohighlight">
\[
\mu = \mu_{max}\frac{S}{K_S+S}
\]</div>
<p>where <span class="math notranslate nohighlight">\(\mu_{max}\)</span> is a maximum specific growth rate and <span class="math notranslate nohighlight">\(K_S\)</span> is a half-saturation constant, which is equivalent to a substrate concentration achieving a half of the maximum specific growth rate as can be seen in Figure \ref{fig:monod}. Combining the above two equations, we can get:</p>
<div class="math notranslate nohighlight">
\[
\frac{dX}{dt}\vert_{growth} = \mu X = \mu_{max} \frac{S}{K_S+S} X
\]</div>
<p>When a substrate concentration is much larger than <span class="math notranslate nohighlight">\(K_S\)</span>, a specific growth rate does not vary as the substrate concentration increases and it is zero-order, while it is first order when the substrate concentration is much smaller than <span class="math notranslate nohighlight">\(K_S\)</span>.</p>
<p>We saw the inhibitory effect of substrate on growth above, but there are other inhibitory effects to be considered, which are temperature and light intensity (only considered for <span class="math notranslate nohighlight">\(X_{ALG}\)</span> in the model).</p>
<p>Process rates covered in the IWA model have a common components, which are a rate constant, a temperature correction (<span class="math notranslate nohighlight">\(e^{\beta (T - T_0)}\)</span>), Monod-type fomulas (<span class="math notranslate nohighlight">\(\frac{S}{K + S}\)</span>),  and particulate concentration (<span class="math notranslate nohighlight">\(X\)</span>). Light intensity effect (<span class="math notranslate nohighlight">\(\frac{I}{K_I}exp(1 - \frac{I}{K_I})\)</span>) is only considered for algae. For Monod-type formulas, when a concentration is very low, a switching function is used: <span class="math notranslate nohighlight">\(\frac{K}{K+S}\)</span>, thereby this term is going to be nearly 1 to avoid making the process rate zero.</p>
<p>Form the perspectives of substrate decomposition, we introduce a yield coefficient, which is a sort of conversion factor, indicating the increase in biomass with a unit of mg per 1 mg of substrate. The value is typically in the range of 0.4 to 0.8 for aerobic heterotophic bacteria.</p>
<div class="math notranslate nohighlight">
\[
\frac{dS}{dt}\vert_{decomposition} = \frac{1}{Y_{X/S}} \frac{dX}{dt}\vert_{growth}
\]</div>
<p>Table lists stoichiometric parameters used in the IWA model. Values included in this matrix are calculated from stoichiometric parameters such as yield coefficients.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Symbol</p></th>
<th class="head"><p>Description</p></th>
<th class="head"><p>Unit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(Y_{H,aer}\)</span></p></td>
<td><p>Yield for aerobic heterotrophic growth</p></td>
<td><p><span class="math notranslate nohighlight">\(gX_H/gS_s\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(Y_{H,anox, NO_3}\)</span></p></td>
<td><p>Yield for anoxic heterotrophic growth with nitrate</p></td>
<td><p><span class="math notranslate nohighlight">\(gX_H/gS_s\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(Y_{H,anox, NO_2}\)</span></p></td>
<td><p>Yield for anoxic heterotrophic growth with nitrite</p></td>
<td><p><span class="math notranslate nohighlight">\(gX_H/gS_s\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(Y_{N_1}\)</span></p></td>
<td><p>Yield for growth of 1st step nitrifiers</p></td>
<td><p><span class="math notranslate nohighlight">\(gX_{N1}/gS_{NH_4-N}\)</span></p></td>
</tr>
<tr class="row-even"><td><p><span class="math notranslate nohighlight">\(Y_{N_2}\)</span></p></td>
<td><p>Yield for growth of 2nd step nitrifiers</p></td>
<td><p><span class="math notranslate nohighlight">\(gX_{N2}/gS_{NO_2-N}\)</span></p></td>
</tr>
<tr class="row-odd"><td><p><span class="math notranslate nohighlight">\(Y_{CON}\)</span></p></td>
<td><p>Yield for grazing</p></td>
<td><p><span class="math notranslate nohighlight">\(gX_{CON}/gX_{ALG}\)</span></p></td>
</tr>
</tbody>
</table>
<p>Let’s look at how to construct a reaction rate for nitrite as an example. There are four stoichiometric coefficients (i.e., 1.1, -1.6, 4.7, -21) as you can see in Figure \ref{fig:stoichi-matrix}. We multiply them by process rates in corresponding rows (i.e., 3a, 3b, 5 and 7), and add all of them.</p>
<div class="math notranslate nohighlight">
\[
r_{NO_2} = 1.1\cdot\rho_{3a} - 1.6\cdot \rho_{3b} + 4.7\cdot \rho_{5} -21\cdot \rho_{7}
\]</div>
<p>where <span class="math notranslate nohighlight">\(\rho_{3a}\)</span>, <span class="math notranslate nohighlight">\(\rho_{3b}\)</span>, <span class="math notranslate nohighlight">\(\rho_{5}\)</span> and <span class="math notranslate nohighlight">\(\rho_{7}\)</span> are given below:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
  \begin{split}
    \rho_{3a}&amp; = k_{gro,H,anox, T_0} \cdot e^{\beta_H(T-T_0)} \\
    &amp; \times \frac{S_s}{K_{S,H,anox}+S_S}\frac{K_{O2,H,aer}}{K_{O2,H,aer}+S_{O2}} \\
    &amp; \times \frac{S_{NO3}}{K_{NO3,H,anox}+S_{NO3}}\frac{S_{HPO4}+S_{H2PO4}}{K_{HPO4,H,anox} + S_{HPO4}+S_{H2PO4}}X_H
  \end{split}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
  \begin{split}
    \rho_{3b}&amp; = k_{gro,H,anox, T_0} \cdot e^{\beta_H(T-T_0)} \\
    &amp; \times \frac{S_s}{K_{S,H,anox}+S_S}\frac{K_{O2,H,aer}}{K_{O2,H,aer}+S_{O2}} \\
    &amp; \times \frac{S_{NO2}}{K_{NO2,H,anox}+S_{NO2}}\frac{S_{HPO4}+S_{H2PO4}}{K_{HPO4,H,anox} + S_{HPO4}+S_{H2PO4}}X_H
  \end{split}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
  \begin{split}
    \rho_{5}&amp; = k_{gro,N1,anox, T_0} \cdot e^{\beta_{N1}(T-T_0)} \\
    &amp; \times\frac{S_{O2}}{K_{O2,N1}+S_{O2}}\frac{S_{NH4}+S_{NH3}}{K_{NH4,N1}+S_{NH4}+S_{NH3}} \\
    &amp; \times \frac{S_{HPO4}+S_{H2PO4}}{K_{HPO4,H,anox} + S_{HPO4}+S_{H2PO4}}X_{N1}
  \end{split}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
  \begin{split}
    \rho_{7}&amp; = k_{gro,N2, T_0} \cdot e^{\beta_{N2}(T-T_0)} \\
    &amp; \times\frac{S_{O2}}{K_{O2,N2}+S_{O2}}\frac{S_{NO2}}{K_{NO2,N2}+S_{NO2}} \\
    &amp; \times \frac{S_{HPO4}+S_{H2PO4}}{K_{HPO4,H,anox} + S_{HPO4}+S_{H2PO4}}X_{N2}
  \end{split}
\end{split}\]</div>
</section>
<section id="implementation">
<h2><span class="section-number">4.2. </span>Implementation<a class="headerlink" href="#implementation" title="Permalink to this heading">#</a></h2>
<p>We adapt a tanks-in-series model to simplify the complex system of a real river. A river branch is segmented into conceptual reservoirs based on the locations of interest, boundary locations and network set-up~\cite{keupers2017development}.</p>
<div class="math notranslate nohighlight">
\[
V_i \frac{dC_i}{dt} = Q(C_{i-1} - C_i) + r_i V_i
\]</div>
<p>In the simulation, we need to determine the target area. The covered part is a river stream between Jugo and Kuki, which is 2750 m long. A river receives rainwater as well as wastewater discharged from households at several points. There are three mixing points (named Jugo, Kyugo, and Chubu) to be considered in this simulation as shown in Table. At each mixing point, we update values of a concentration, a flow velocity, and the number of reservoirs in the downstream. Concentrations after mixing are used as the new initial conditions. In between Chubu and Kuki, wastewater is directly discharged from households into the river. Those nonpoint sources are introduced as constant model inputs for each segment. Concentrations of water quality parameters such as BOD, DO, <span class="math notranslate nohighlight">\(NH_4\)</span>, <span class="math notranslate nohighlight">\(NO_2\)</span>+<span class="math notranslate nohighlight">\(NO_3\)</span> are monitored monthly at Chubu and Kuki.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>Point</p></th>
<th class="head"><p>Distance (m)</p></th>
<th class="head"><p>Flow of wastewater (<span class="math notranslate nohighlight">\(m^3\)</span>)</p></th>
<th class="head"><p>Covered land area (<span class="math notranslate nohighlight">\(m^{2}\)</span>)</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Jugo</p></td>
<td><p>0</p></td>
<td><p>135.0</p></td>
<td><p>926,000</p></td>
</tr>
<tr class="row-odd"><td><p>Kyugo</p></td>
<td><p>390</p></td>
<td><p>52.7</p></td>
<td><p>860,000</p></td>
</tr>
<tr class="row-even"><td><p>Chubu</p></td>
<td><p>1260</p></td>
<td><p>78.9</p></td>
<td><p>1,521,000</p></td>
</tr>
<tr class="row-odd"><td><p>Kuki</p></td>
<td><p>2750</p></td>
<td><p>421.4</p></td>
<td><p>688,000</p></td>
</tr>
</tbody>
</table>
<p>Inputs of the model are monthly average water temperature, irradiation, and precipitation. A flow rate after mixing (<span class="math notranslate nohighlight">\(Q_{all}\)</span>) is the sum of the river flow (<span class="math notranslate nohighlight">\(Q_{river}\)</span>), a discharge due to precipitation (<span class="math notranslate nohighlight">\( Q_{precipitation}\)</span>), an amount of wastewater discharged from septic tanks (<span class="math notranslate nohighlight">\(Q_{discharge}\)</span>):</p>
<div class="math notranslate nohighlight">
\[
Q_{all} =  Q_{river} + Q_{discharge} + Q_{precipitation}
\]</div>
<div class="math notranslate nohighlight">
\[
Q_{precipitation} [m^3/d] = 0.74 \times Land\:area [m^2] \times \frac{Precipitation\:[mm/month]}{(1000 \times 30)} 
\]</div>
<div class="math notranslate nohighlight">
\[
Q_{discharge} [m^3/d] = 250 [L] \times Population \times \frac{1}{1000}
\]</div>
<p><span class="math notranslate nohighlight">\(Q_{river}\)</span> at Jugo is estimated like <span class="math notranslate nohighlight">\(Q_{precipitation}\)</span>; in other locations, <span class="math notranslate nohighlight">\(Q_{river}\)</span> is a previous state of <span class="math notranslate nohighlight">\(Q_{all}\)</span> in a loop of the simulation. After mixing, a horizontal flow velocity (<span class="math notranslate nohighlight">\(u\)</span>) can be calculated using the following two equations. Equating the right-hand sides of two equations allows us to calculate a depth (<span class="math notranslate nohighlight">\(H\)</span>) using a iterative method which is compiled as a function as shown below.</p>
<div class="math notranslate nohighlight">
\[
u = \frac{Q_{all}}{B \times H} 
\]</div>
<div class="math notranslate nohighlight">
\[
u = \frac{1}{n} \times R^{2/3} \times I^{1/2}
\]</div>
<p>where, <span class="math notranslate nohighlight">\(B\)</span> is the width, <span class="math notranslate nohighlight">\(n\)</span> is a Manning roughness coefficient, <span class="math notranslate nohighlight">\(R\)</span> is a hydraulic radius and <span class="math notranslate nohighlight">\(I\)</span> is a slope. While values for <span class="math notranslate nohighlight">\(B\)</span>, <span class="math notranslate nohighlight">\(n\)</span> and <span class="math notranslate nohighlight">\(I\)</span> are fixed during simulation, <span class="math notranslate nohighlight">\(R\)</span> is calculated by:</p>
<div class="math notranslate nohighlight">
\[
R = \frac{B \times H}{2H + B}
\]</div>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="k">function </span><span class="n">depth_calc</span><span class="p">(</span><span class="n">ALL_River_B</span><span class="p">,</span><span class="w"> </span><span class="n">ALLRiver_I</span><span class="p">,</span><span class="w"> </span><span class="n">ALLRiver_n</span><span class="p">,</span><span class="w"> </span><span class="n">ALL_River_Q</span><span class="p">)</span><span class="w"> </span><span class="k">result</span><span class="p">(</span><span class="n">ALL_RIver_H</span><span class="p">)</span>

<span class="w"> </span><span class="kt">real</span><span class="p">(</span><span class="n">real64</span><span class="p">),</span><span class="w"> </span><span class="k">intent</span><span class="p">(</span><span class="n">in</span><span class="p">)</span><span class="w"> </span><span class="kd">::</span><span class="w"> </span><span class="n">ALL_River_B</span><span class="p">,</span><span class="w"> </span><span class="n">ALLRiver_I</span><span class="p">,</span><span class="w"> </span><span class="n">ALLRiver_n</span><span class="p">,</span><span class="w"> </span><span class="n">ALL_River_Q</span>

<span class="w"> </span><span class="kt">integer </span><span class="n">i</span>
<span class="w"> </span><span class="kt">real</span><span class="p">(</span><span class="n">real64</span><span class="p">)</span><span class="w"> </span><span class="n">ALL_RIver_H</span><span class="p">,</span><span class="w"> </span><span class="n">f</span><span class="p">,</span><span class="w"> </span><span class="n">fp</span><span class="p">,</span><span class="w"> </span><span class="n">ALL_River_Q_sec</span>

<span class="w"> </span><span class="c">!initial guess</span>
<span class="w"> </span><span class="n">ALL_RIver_H</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.2d0</span>
<span class="w"> </span><span class="n">ALL_River_Q_sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALL_River_Q</span><span class="o">/</span><span class="nb">dble</span><span class="p">(</span><span class="mi">86400</span><span class="p">)</span>

<span class="w"> </span><span class="k">do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span>
<span class="w">   </span><span class="n">f</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ALL_River_B</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ALLRiver_I</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ALLRiver_n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ALL_River_Q_sec</span><span class="p">)</span><span class="o">*</span><span class="w"> </span><span class="n">ALL_RIver_H</span><span class="o">**</span><span class="mf">1.67</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0d0</span><span class="o">*</span><span class="n">ALL_RIver_H</span><span class="o">/</span><span class="n">ALL_River_B</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.67</span>

<span class="w">   </span><span class="n">fp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">5.0d0</span><span class="o">/</span><span class="mf">3.0d0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ALL_River_B</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">ALLRiver_I</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="p">(</span><span class="n">ALLRiver_n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ALL_River_Q_sec</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ALL_RIver_H</span><span class="o">**</span><span class="mf">0.67</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">2.0d0</span><span class="o">/</span><span class="mf">3.0d0</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0d0</span><span class="o">*</span><span class="n">ALL_RIver_H</span><span class="o">/</span><span class="n">ALL_River_B</span><span class="w">  </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mf">0.33</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mf">2.0d0</span><span class="o">/</span><span class="n">ALL_River_B</span><span class="p">)</span>
<span class="w">  </span>
<span class="w">   </span><span class="n">ALL_RIver_H</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">ALL_RIver_H</span><span class="w">  </span><span class="o">-</span><span class="w"> </span><span class="n">f</span><span class="o">/</span><span class="n">fp</span>
<span class="w"> </span><span class="k">end do</span>
<span class="k"> end function </span><span class="n">depth_calc</span>
</pre></div>
</div>
<p>Dispersion coefficient (<span class="math notranslate nohighlight">\(E\)</span>) and division number (<span class="math notranslate nohighlight">\(Div\)</span>) are estimated by the following equations:</p>
<div class="math notranslate nohighlight">
\[
E = 2 \times \sqrt{gRI} \times H \times (\frac{B}{H})^{1.5}
\]</div>
<div class="math notranslate nohighlight">
\[
Div = \frac{Pe}{2} + 1 = \frac{u \times L}{2E} + 1
\]</div>
<p>where <span class="math notranslate nohighlight">\(Pe\)</span> is a Peclet number and calculated by <span class="math notranslate nohighlight">\(\frac{u\times L}{E}\)</span>. <span class="math notranslate nohighlight">\(L\)</span> is a length of a river reach between mixing points. We use the 4th-order Runge-Kutta method to solve the differential equation for a tanks-in-series model presented at the begining of this chapter:</p>
<div class="math notranslate nohighlight">
\[
V \frac{dC}{dt} = Q(C_{in} - C) + rV
\]</div>
<p>First, we discretize the time derivative.</p>
<div class="math notranslate nohighlight">
\[
V\frac{C_t - C_{t-1}}{\Delta t} = Q(C_{in} - C) + rV
\]</div>
<p>After rearranging the above equation, we get the following equation, introducing <span class="math notranslate nohighlight">\(k\)</span>. Please note that <span class="math notranslate nohighlight">\(r\)</span> is a function of <span class="math notranslate nohighlight">\(C\)</span>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{split}
  C_t&amp; = C_{t-1} + k \Delta t \\
  &amp; = C_{t-1} + \frac{k_1 + 2k_2 + 2k_3 + k_4}{6} \Delta t
\end{split}
\end{split}\]</div>
<p>where,</p>
<div class="math notranslate nohighlight">
\[
k_1 = \left\lbrace \frac{Q}{V}(C_{t-1,x-1} - C_{t-1,x}) + r(C_{t-1,x}) \right\rbrace
\]</div>
<div class="math notranslate nohighlight">
\[
k_2 = \left\lbrace \frac{Q}{V}(C_{t-1,x-1} - (C_{t-1,x} + \frac{k_1}{2} dt)) + r(C_{t-1,x} + \frac{k_1}{2} dt))\right\rbrace 
\]</div>
<div class="math notranslate nohighlight">
\[
k_3 = \left\lbrace \frac{Q}{V}(C_{t-1,x-1} - (C_{t-1,x} + \frac{k_2}{2} dt)) + r(C_{t-1,x} + \frac{k_2}{2} dt))\right\rbrace 
\]</div>
<div class="math notranslate nohighlight">
\[
k_4 = \left\lbrace \frac{Q}{V}(C_{t-1,x-1} - (C_{t-1,x} + k_3 dt)) + r(C_{t-1,x} + k_3 dt)\right\rbrace 
\]</div>
<p>We use three <span class="math notranslate nohighlight">\(\verb|do loop|\)</span>s as can be seen below. The most inner loop is for calculation of <span class="math notranslate nohighlight">\(\verb|k|\)</span>. After this loop, we will estimate concentrations at the next time level using the 4th-order Runge-Kutta method. Below is the excepted code for one of items. We prepare a 2-D array for each water quality item (e.g., <span class="math notranslate nohighlight">\(\verb|ALLRiver_SS|\)</span> for <span class="math notranslate nohighlight">\(\verb|SS|\)</span>).</p>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">do </span><span class="n">Time_Pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Time_Total</span>
<span class="w">   </span><span class="k">do </span><span class="n">Loc_Pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">Div_Total</span>
<span class="w">     </span><span class="k">do </span><span class="n">Runge_Pointer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span>
<span class="w">       </span><span class="n">RungeK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Runge_Pointer</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">...</span>
<span class="w">     </span><span class="k">end do</span><span class="w"> </span><span class="c">!Runge_Pointer</span>

<span class="w">     </span><span class="n">ALLRiver_SS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="n">Loc_Pointer</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Loc_Pointer</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">((</span><span class="n">RungeK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0d0</span><span class="o">*</span><span class="n">RungeK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mf">2.0d0</span><span class="o">*</span><span class="n">RungeK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">RungeK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">4</span><span class="p">))</span><span class="o">*</span><span class="n">deltaT</span><span class="o">/</span><span class="mf">6.0d0</span>
</pre></div>
</div>
<p><span class="math notranslate nohighlight">\(\verb|RungeK|\)</span> is a 2-D array and corresponds to <span class="math notranslate nohighlight">\(k_1\)</span> to <span class="math notranslate nohighlight">\(k_4\)</span>. The second dimension of <span class="math notranslate nohighlight">\(\verb|RungeK|\)</span> is assigned for \verb|Runge_Pointer|. As previously explained, in the area between Chubu and Kuki, wastewater discharged from each household directly enters the stream. A reservoir in the reach receive not only inflow from the previous reservoir as well as the direct discharged wastewater. We assume that the directly discharged wastewater equally flows to each reservoir.</p>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mixingPoint</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">  do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span>
<span class="w">   </span><span class="n">RungeK</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">Runge_Pointer</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="w"> </span><span class="n">ALLRiver_TankV</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">ALLRiver_Q</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">Tempval_Inf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">SepticDischarge</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="n">Div_Total</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Direct_DischargeWQ</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="o">/</span><span class="n">SepticDischarge</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="p">(</span><span class="n">ALLRiver_Q</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">SepticDischarge</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">/</span><span class="n">Div_Total</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">TempPointer</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w">  </span><span class="n">ReactionTerm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="k">end do </span>
<span class="k"> else </span>
<span class="k">  do </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">14</span>
<span class="w">   </span><span class="n">RungeK</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">Runge_Pointer</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">ALLRiver_Q</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">ALLRiver_TankV</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">Tempval_Inf</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">TempPointer</span><span class="p">(</span><span class="n">i</span><span class="p">))</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ReactionTerm</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">  </span><span class="k">end do </span>
<span class="k"> end if</span>
</pre></div>
</div>
<p>Please note that <span class="math notranslate nohighlight">\(\verb|Tempval_Inf|\)</span> indicates concentrations in the previous tank so that <span class="math notranslate nohighlight">\(\verb|Loc_Pointer-1|\)</span> is allocated.</p>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="n">Tempval_Inf</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">Loc_Pointer</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p><span class="math notranslate nohighlight">\(\verb|TempPointer|\)</span> (corresponds to <span class="math notranslate nohighlight">\(C_{t-1,x-1}\)</span>), and <span class="math notranslate nohighlight">\(\verb|reactionTerm|\)</span> are different depending on <span class="math notranslate nohighlight">\(\verb|Runge_Pointer|\)</span>.</p>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">Runge_Pointer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">TempPointer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Loc_Pointer</span><span class="p">)</span>
<span class="w"> </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">Runge_Pointer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">TempPointer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Loc_Pointer</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">RungeK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">deltaT</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0d0</span><span class="p">)</span>
<span class="w"> </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">Runge_Pointer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">TempPointer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Loc_Pointer</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">RungeK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">deltaT</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">2.0d0</span><span class="p">)</span>
<span class="w"> </span><span class="k">else if</span><span class="w"> </span><span class="p">(</span><span class="n">Runge_Pointer</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">   </span><span class="n">TempPointer</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">Loc_Pointer</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">RungeK</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span><span class="w">  </span><span class="o">*</span><span class="w"> </span><span class="n">deltaT</span>
<span class="w"> </span><span class="k">end if</span>
</pre></div>
</div>
<p>As we saw in the background sub-section, a reaction rate, which corresponds to <span class="math notranslate nohighlight">\(\verb|reactionTerm|\)</span>, is calculated using a matrix operation.</p>
<div class="math notranslate nohighlight">
\[
r_i = \sum\nu_{i,j}\rho_j
\]</div>
<p>Here is the best occasion to use <span class="math notranslate nohighlight">\(\verb|matmul|\)</span>, a built-in function for matrix multiplication. <span class="math notranslate nohighlight">\(\verb|Chemsp|\)</span> and <span class="math notranslate nohighlight">\(\verb|ProcessMat|\)</span> are 2-D arrays, storing stoichiometry values and process rate equations, respectively.</p>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="n">reactionTerm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">matmul</span><span class="p">(</span><span class="nb">transpose</span><span class="p">(</span><span class="n">Chemsp</span><span class="p">),</span><span class="w"> </span><span class="n">ProcessMat</span><span class="p">)</span>
</pre></div>
</div>
<p>Model variables in the IWA river water quality model does not necessarily match routinely-monitored water quality items in the field. We need to convert data to compare simulation outputs with observed data. As we have data of BOD, SS, ammonium, nitrate, nitrite and DO, we prepare five additional arrays as the following:</p>
<div class="highlight-Fortran notranslate"><div class="highlight"><pre><span></span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">mod</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="n">print_count</span><span class="p">).</span><span class="n">eq</span><span class="p">.</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">then</span>
<span class="k">    </span><span class="n">ALLRiver_BOD</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ALLRiver_XS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">ALLRiver_SSolid</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_XH</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ALLRiver_XN1</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ALLRiver_XN2</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ALLRiver_XALG</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ALLRiver_XCON</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ALLRiver_XS</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ALLRiver_XI</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span>
<span class="w">    </span>
<span class="w">    </span><span class="n">ALLRiver_NOX</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SNO2</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ALLRiver_SNO3</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span>
<span class="w">    </span>
<span class="w">    </span><span class="n">ALLRiver_NH4</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SNH4</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span><span class="w"> </span>
<span class="w">    </span>
<span class="w">    </span><span class="n">ALLRIver_O2</span><span class="p">(:)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ALLRiver_SO2</span><span class="p">(</span><span class="n">Time_Pointer</span><span class="p">,</span><span class="w"> </span><span class="p">:)</span>

<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(*(g0:,&quot;,&quot;))&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">ALLRiver_BOD</span><span class="p">(:)</span>
<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(*(g0:,&quot;,&quot;))&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">ALLRiver_SSolid</span><span class="p">(:)</span>
<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(*(g0:,&quot;,&quot;))&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">ALLRiver_NOX</span><span class="p">(:)</span>
<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(*(g0:,&quot;,&quot;))&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">ALLRiver_NH4</span><span class="p">(:)</span>
<span class="w">    </span><span class="k">write</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;(*(g0:,&quot;,&quot;))&#39;</span><span class="p">)</span><span class="w"> </span><span class="n">ALLRiver_O2</span><span class="p">(:)</span>
<span class="w">  </span><span class="k">end if</span>
</pre></div>
</div>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./water-quality-modeling"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="streeterPhelps.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title"><span class="section-number">3. </span>Streeter Phelps Model</p>
      </div>
    </a>
    <a class="right-next"
       href="lakeModel.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="section-number">5. </span>Lake Model</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#background">4.1. Background</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">4.2. Implementation</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Yoshihiko Inagaki
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=ac02cc09edc035673794"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=ac02cc09edc035673794"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>